<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">ip monitor - configuration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .config-locked {
            background: linear-gradient(45deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
        }
        
        .input-group {
            transition: all 0.2s ease;
        }
        
        .input-group:focus-within {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-100">
    <!-- Navigation -->
    <nav class="glass sticky top-0 z-50 border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 flex items-center justify-center">
                        <i data-lucide="settings" class="w-5 h-5 text-white"></i>
                    </div>
                    <h1 id="appNameConfig" class="text-xl font-bold text-gray-900">ip monitor - configuration</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200">
                        <i data-lucide="home" class="w-4 h-4 mr-2"></i>
                        Dashboard
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Configuration Status -->
        <div class="glass rounded-2xl p-6 mb-8 fade-in">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div id="configStatusIcon" class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                        <i data-lucide="settings" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">Configuration Management</h2>
                        <p class="text-gray-600">Source: <span id="configSource" class="font-medium">Loading...</span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="resetConfig()" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200">
                        <i data-lucide="rotate-ccw" class="w-4 h-4 mr-2"></i>
                        Reset
                    </button>
                    <button onclick="exportConfig()" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                        Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Lock Warning -->
        <div id="lockWarning" class="config-locked rounded-2xl p-6 mb-8 hidden">
            <div class="flex items-center space-x-4 mb-4">
                <i data-lucide="lock" class="w-6 h-6 text-amber-600"></i>
                <div>
                    <h3 class="text-lg font-semibold text-amber-800">Configuration Locked</h3>
                    <p class="text-amber-700">Settings are controlled by environment variables and cannot be edited through the web interface.</p>
                </div>
            </div>
            <div class="flex space-x-3">
                <button onclick="migrateConfig()" class="inline-flex items-center px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium transition-colors duration-200">
                    <i data-lucide="migrate" class="w-4 h-4 mr-2"></i>
                    Migrate to File Configuration
                </button>
                <button onclick="showEnvHelp()" class="inline-flex items-center px-4 py-2 bg-amber-100 hover:bg-amber-200 text-amber-800 rounded-lg font-medium transition-colors duration-200">
                    <i data-lucide="help-circle" class="w-4 h-4 mr-2"></i>
                    Help
                </button>
            </div>
        </div>

        <!-- Configuration Form -->
        <form id="configForm" class="space-y-8">
            <!-- IP Configuration -->
            <div class="glass rounded-2xl p-6 fade-in">
                <div class="flex items-center space-x-3 mb-6">
                    <i data-lucide="shield-check" class="w-5 h-5 text-green-600"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Safe IP Range Configuration</h3>
                </div>

                <div class="input-group bg-white/60 rounded-xl p-4 border border-white/30">
                    <label for="safeRanges" class="block text-sm font-medium text-gray-700 mb-2">
                        Safe IP Ranges
                        <span class="text-red-500">*</span>
                    </label>
                    <textarea id="safeRanges" name="safe_ip_range" rows="3" 
                              placeholder="192.168.1.0/24"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"></textarea>
                    <p class="text-xs text-gray-500 mt-2">
                        Comma-separated CIDR ranges. Alerts trigger when IP is NOT in any of these ranges (e.g., when not at home).
                    </p>
                </div>

                <div class="input-group bg-white/60 rounded-xl p-4 border border-white/30 mt-4">
                    <label for="alertCooldown" class="block text-sm font-medium text-gray-700 mb-2">
                        Alert Cooldown Period
                    </label>
                    <input type="text" id="alertCooldown" name="alert_cooldown" 
                           placeholder="1h" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-2">
                        Minimum time between alerts (e.g., "1h", "30m", "2h30m")
                    </p>
                </div>
            </div>

            <!-- Webhook Configuration -->
            <div class="glass rounded-2xl p-6 fade-in">
                <div class="flex items-center space-x-3 mb-6">
                    <i data-lucide="webhook" class="w-5 h-5 text-green-600"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Webhook Configuration</h3>
                </div>

                <div class="space-y-4">
                    <div class="input-group bg-white/60 rounded-xl p-4 border border-white/30">
                        <label for="webhookUrl" class="block text-sm font-medium text-gray-700 mb-2">
                            Webhook URL
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="url" id="webhookUrl" name="webhook_url" 
                               placeholder="http://your-home-assistant:8123/api/webhook/your_webhook_id"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-2">
                            HTTP endpoint to receive alert notifications
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group bg-white/60 rounded-xl p-4 border border-white/30">
                            <label for="webhookMethod" class="block text-sm font-medium text-gray-700 mb-2">
                                HTTP Method
                            </label>
                            <select id="webhookMethod" name="webhook_method" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="PATCH">PATCH</option>
                                <option value="GET">GET</option>
                                <option value="HEAD">HEAD</option>
                            </select>
                        </div>

                        <div class="input-group bg-white/60 rounded-xl p-4 border border-white/30">
                            <label for="checkInterval" class="block text-sm font-medium text-gray-700 mb-2">
                                Check Interval
                            </label>
                            <input type="text" id="checkInterval" name="check_interval" 
                                   placeholder="12h" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-2">
                                How often to check IP (e.g., "12h", "6h", "30m")
                            </p>
                        </div>
                    </div>

                    <!-- Authentication -->
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <div class="flex items-center space-x-2 mb-4">
                            <i data-lucide="shield" class="w-4 h-4 text-gray-600"></i>
                            <h4 class="font-medium text-gray-900">Authentication (Optional)</h4>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="input-group">
                                <label for="webhookUser" class="block text-sm font-medium text-gray-700 mb-2">
                                    Username
                                </label>
                                <input type="text" id="webhookUser" name="webhook_user" 
                                       placeholder="username" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>

                            <div class="input-group">
                                <label for="webhookPass" class="block text-sm font-medium text-gray-700 mb-2">
                                    Password
                                </label>
                                <input type="password" id="webhookPass" name="webhook_pass" 
                                       placeholder="password" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="glass rounded-2xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="save" class="w-5 h-5 text-blue-600"></i>
                        <span class="text-lg font-semibold text-gray-900">Save Configuration</span>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="button" onclick="testConfiguration()" 
                                class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors duration-200 disabled:opacity-50" 
                                id="testBtn">
                            <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                            Test Webhook
                        </button>
                        
                        <button type="submit" 
                                class="inline-flex items-center px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200 disabled:opacity-50" 
                                id="saveBtn">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Configuration Preview -->
        <div class="glass rounded-2xl p-6 mt-8 fade-in">
            <div class="flex items-center space-x-3 mb-6">
                <i data-lucide="eye" class="w-5 h-5 text-gray-600"></i>
                <h3 class="text-lg font-semibold text-gray-900">Configuration Preview</h3>
            </div>
            
            <div class="bg-gray-900 rounded-lg p-4">
                <pre id="configPreview" class="text-green-400 text-sm font-mono overflow-x-auto">
# Loading configuration...
                </pre>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span class="text-gray-900 font-medium">Processing...</span>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg max-w-2xl mx-4 max-h-96 overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Environment Variable Configuration</h3>
                    <button onclick="hideEnvHelp()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="space-y-4 text-sm text-gray-700">
                    <p>When configuration is locked by environment variables, you need to modify your <code class="bg-gray-100 px-1 rounded">docker-compose.yml</code> file:</p>
                    
                    <div class="bg-gray-900 rounded-lg p-4">
                        <pre class="text-green-400 text-xs"><code>environment:
  - SAFE_IP_RANGE=192.168.1.0/24
  - WEBHOOK_URL=http://homeassistant.local:8123/api/webhook/id
  - WEBHOOK_METHOD=POST
  - WEBHOOK_USER=username
  - WEBHOOK_PASS=password
  - CHECK_INTERVAL=12h
  - ALERT_COOLDOWN=1h</code></pre>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-4">
                        <p class="font-medium text-blue-800 mb-2">To enable web configuration:</p>
                        <ol class="list-decimal list-inside space-y-1 text-blue-700">
                            <li>Click "Migrate to File Configuration" above</li>
                            <li>Remove environment variables from docker-compose.yml</li>
                            <li>Restart the container: <code class="bg-blue-100 px-1 rounded">docker-compose restart</code></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        let currentConfig = {};
        let originalConfig = {};

        function showLoading(show = true) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `bg-white border-l-4 ${type === 'error' ? 'border-red-500' : type === 'success' ? 'border-green-500' : 'border-blue-500'} rounded-lg shadow-lg p-4 min-w-72 transform translate-x-full transition-transform duration-300`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="${type === 'error' ? 'alert-circle' : type === 'success' ? 'check-circle' : 'info'}" class="w-5 h-5 ${type === 'error' ? 'text-red-500' : type === 'success' ? 'text-green-500' : 'text-blue-500'} mr-3"></i>
                    <span class="text-gray-900">${message}</span>
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function updateConfigPreview() {
            const preview = document.getElementById('configPreview');
            const config = getCurrentFormData();
            
            preview.textContent = `# ip monitor Configuration
safe_ip_range: ${config.safe_ip_range || 'Not set'}
webhook_url: ${config.webhook_url || 'Not set'}
webhook_method: ${config.webhook_method || 'POST'}
webhook_authentication: ${config.webhook_user ? 'Enabled' : 'Disabled'}
check_interval: ${config.check_interval || '12h'}
alert_cooldown: ${config.alert_cooldown || '1h'}

# Configuration source: ${currentConfig.config_source || 'unknown'}
# Editable via web: ${currentConfig.is_editable ? 'Yes' : 'No'}`;
        }

        function getCurrentFormData() {
            return {
                safe_ip_range: document.getElementById('safeRanges').value,
                webhook_url: document.getElementById('webhookUrl').value,
                webhook_method: document.getElementById('webhookMethod').value,
                webhook_user: document.getElementById('webhookUser').value,
                webhook_pass: document.getElementById('webhookPass').value,
                check_interval: document.getElementById('checkInterval').value,
                alert_cooldown: document.getElementById('alertCooldown').value
            };
        }

        function populateForm(config) {
            document.getElementById('safeRanges').value = config.safe_ip_range || '';
            document.getElementById('webhookUrl').value = config.webhook_url || '';
            document.getElementById('webhookMethod').value = config.webhook_method || 'POST';
            document.getElementById('webhookUser').value = config.webhook_user || '';
            document.getElementById('webhookPass').value = config.webhook_pass || '';
            document.getElementById('checkInterval').value = config.check_interval || '12h';
            document.getElementById('alertCooldown').value = config.alert_cooldown || '1h';
            
            // Update app name in UI
            const appName = config.app_name || 'ip monitor';
            document.getElementById('appNameConfig').textContent = `${appName} - configuration`;
            document.getElementById('pageTitle').textContent = `${appName} - configuration`;
            
            updateConfigPreview();
        }

        function updateUI() {
            const isEditable = currentConfig.is_editable;
            const source = currentConfig.config_source || 'unknown';
            
            // Update status
            document.getElementById('configSource').textContent = source;
            
            // Show/hide lock warning
            const lockWarning = document.getElementById('lockWarning');
            lockWarning.classList.toggle('hidden', isEditable);
            
            // Enable/disable form
            const form = document.getElementById('configForm');
            const inputs = form.querySelectorAll('input, select, textarea, button');
            inputs.forEach(input => {
                input.disabled = !isEditable;
            });
            
            // Update status icon
            const statusIcon = document.getElementById('configStatusIcon');
            if (isEditable) {
                statusIcon.className = 'w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center';
                statusIcon.innerHTML = '<i data-lucide="unlock" class="w-5 h-5 text-green-600"></i>';
            } else {
                statusIcon.className = 'w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center';
                statusIcon.innerHTML = '<i data-lucide="lock" class="w-5 h-5 text-amber-600"></i>';
            }
            
            lucide.createIcons();
        }

        async function fetchConfig() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) throw new Error('Failed to fetch configuration');
                
                currentConfig = await response.json();
                originalConfig = { ...currentConfig };
                
                populateForm(currentConfig);
                updateUI();
                
            } catch (error) {
                console.error('Error fetching config:', error);
                showToast('Failed to load configuration: ' + error.message, 'error');
            }
        }

        async function saveConfiguration(event) {
            event.preventDefault();
            
            if (!currentConfig.is_editable) {
                showToast('Configuration is locked by environment variables', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const formData = getCurrentFormData();
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showToast('Configuration saved successfully', 'success');
                    await fetchConfig(); // Refresh
                } else {
                    showToast('Failed to save configuration: ' + (result.error || 'Unknown error'), 'error');
                }
                
            } catch (error) {
                showToast('Error saving configuration: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function testConfiguration() {
            const btn = document.getElementById('testBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>Testing...';
            
            try {
                const response = await fetch('/api/webhook-test');
                const result = await response.json();
                
                if (result.success) {
                    showToast('Webhook test successful', 'success');
                } else {
                    showToast('Webhook test failed: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error testing webhook: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="zap" class="w-4 h-4 mr-2"></i>Test Webhook';
                lucide.createIcons();
            }
        }

        async function migrateConfig() {
            showLoading(true);
            
            try {
                const response = await fetch('/api/config/migrate', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    setTimeout(() => {
                        fetchConfig();
                        showLoading(false);
                    }, 1000);
                } else {
                    showToast(result.message || 'Migration failed', 'error');
                    showLoading(false);
                }
            } catch (error) {
                showToast('Error migrating configuration: ' + error.message, 'error');
                showLoading(false);
            }
        }

        function resetConfig() {
            if (confirm('Reset configuration to original values? Unsaved changes will be lost.')) {
                populateForm(originalConfig);
                showToast('Configuration reset', 'info');
            }
        }

        function exportConfig() {
            const config = getCurrentFormData();
            const dataStr = JSON.stringify(config, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `ip-monitor-config-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('Configuration exported', 'success');
        }

        function showEnvHelp() {
            document.getElementById('helpModal').classList.remove('hidden');
        }

        function hideEnvHelp() {
            document.getElementById('helpModal').classList.add('hidden');
        }

        // Event listeners
        document.getElementById('configForm').addEventListener('submit', saveConfiguration);

        // Update preview when form changes
        ['input', 'change'].forEach(event => {
            document.getElementById('configForm').addEventListener(event, updateConfigPreview);
        });

        // Initialize
        fetchConfig();
    </script>
</body>
</html>