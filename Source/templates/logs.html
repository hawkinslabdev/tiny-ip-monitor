<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ip monitor - logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .log-line {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .log-line:hover {
            background-color: rgba(55, 65, 81, 0.1);
            border-left-color: #3b82f6;
        }
        
        .log-info { border-left-color: #10b981; }
        .log-warning { border-left-color: #f59e0b; }
        .log-error { border-left-color: #ef4444; }
        
        .search-highlight {
            background-color: #fef3c7;
            padding: 1px 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-100">
    <!-- Navigation -->
    <nav class="glass sticky top-0 z-50 border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 flex items-center justify-center">
                        <i data-lucide="file-text" class="w-5 h-5 text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900">ip monitor - logs</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200">
                        <i data-lucide="home" class="w-4 h-4 mr-2"></i>
                        Dashboard
                    </a>
                    <a href="/config" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200">
                        <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
                        Config
                    </a>
                    <button onclick="refreshLogs()" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Controls -->
        <div class="glass rounded-2xl p-6 mb-8 fade-in">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
                <div class="flex items-center space-x-3">
                    <i data-lucide="search" class="w-5 h-5 text-gray-600"></i>
                    <h2 class="text-xl font-semibold text-gray-900">Log Viewer</h2>
                </div>
                
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                    <!-- Search -->
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                        <input type="text" id="searchInput" placeholder="Search logs..." 
                               class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-64">
                    </div>
                    
                    <!-- Level Filter -->
                    <select id="levelFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Levels</option>
                        <option value="INFO">Info</option>
                        <option value="WARNING">Warning</option>
                        <option value="ERROR">Error</option>
                    </select>
                    
                    <!-- Lines Count -->
                    <select id="linesCount" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="50">50 lines</option>
                        <option value="100" selected>100 lines</option>
                        <option value="200">200 lines</option>
                        <option value="500">500 lines</option>
                        <option value="1000">1000 lines</option>
                    </select>
                    
                    <!-- Auto-refresh -->
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="autoRefresh" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-sm text-gray-700">Auto-refresh</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Log Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 fade-in">
            <div class="glass rounded-xl p-6">
                <div class="flex items-center space-x-3">
                    <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                    <div>
                        <p class="text-sm text-gray-600">Total Lines</p>
                        <p id="totalLines" class="text-xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-xl p-6">
                <div class="flex items-center space-x-3">
                    <i data-lucide="info" class="w-5 h-5 text-green-600"></i>
                    <div>
                        <p class="text-sm text-gray-600">Info</p>
                        <p id="infoCount" class="text-xl font-bold text-green-700">0</p>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-xl p-6">
                <div class="flex items-center space-x-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600"></i>
                    <div>
                        <p class="text-sm text-gray-600">Warnings</p>
                        <p id="warningCount" class="text-xl font-bold text-yellow-700">0</p>
                    </div>
                </div>
            </div>
            
            <div class="glass rounded-xl p-6">
                <div class="flex items-center space-x-3">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
                    <div>
                        <p class="text-sm text-gray-600">Errors</p>
                        <p id="errorCount" class="text-xl font-bold text-red-700">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log Content -->
        <div class="glass rounded-2xl p-6 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <i data-lucide="terminal" class="w-5 h-5 text-gray-600"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Log Entries</h3>
                    <span id="filteredCount" class="text-sm text-gray-500">(0 entries)</span>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button onclick="exportLogs()" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                        Export
                    </button>
                    <button onclick="clearSearch()" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200">
                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                        Clear
                    </button>
                </div>
            </div>

            <div class="bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto" id="logContainer">
                <div id="logContent" class="font-mono text-sm space-y-1">
                    <div class="text-gray-500 text-center py-8">Loading logs...</div>
                </div>
            </div>
            
            <!-- Scroll to bottom button -->
            <button id="scrollBottomBtn" onclick="scrollToBottom()" 
                    class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg transition-all duration-200 hidden">
                <i data-lucide="arrow-down" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        let allLogs = [];
        let filteredLogs = [];
        let autoRefreshInterval = null;

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `bg-white border-l-4 ${type === 'error' ? 'border-red-500' : type === 'success' ? 'border-green-500' : 'border-blue-500'} rounded-lg shadow-lg p-4 min-w-72 transform translate-x-full transition-transform duration-300`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="${type === 'error' ? 'alert-circle' : type === 'success' ? 'check-circle' : 'info'}" class="w-5 h-5 ${type === 'error' ? 'text-red-500' : type === 'success' ? 'text-green-500' : 'text-blue-500'} mr-3"></i>
                    <span class="text-gray-900">${message}</span>
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function getLogLevel(logLine) {
            if (logLine.includes('] INFO:')) return 'INFO';
            if (logLine.includes('] WARNING:')) return 'WARNING';
            if (logLine.includes('] ERROR:')) return 'ERROR';
            return 'UNKNOWN';
        }

        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return escapeHtml(text);
            
            const escapedText = escapeHtml(text);
            const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
            return escapedText.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ip monitor - logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg');
        }

        function updateLogStats() {
            const stats = {
                total: allLogs.length,
                info: allLogs.filter(log => getLogLevel(log) === 'INFO').length,
                warning: allLogs.filter(log => getLogLevel(log) === 'WARNING').length,
                error: allLogs.filter(log => getLogLevel(log) === 'ERROR').length
            };
            
            document.getElementById('totalLines').textContent = stats.total;
            document.getElementById('infoCount').textContent = stats.info;
            document.getElementById('warningCount').textContent = stats.warning;
            document.getElementById('errorCount').textContent = stats.error;
        }

        function filterLogs() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const levelFilter = document.getElementById('levelFilter').value;
            
            filteredLogs = allLogs.filter(log => {
                const matchesSearch = !searchTerm || log.toLowerCase().includes(searchTerm);
                const matchesLevel = !levelFilter || getLogLevel(log) === levelFilter;
                return matchesSearch && matchesLevel;
            });
            
            displayLogs();
        }

        function displayLogs() {
            const logContent = document.getElementById('logContent');
            const searchTerm = document.getElementById('searchInput').value;
            
            if (filteredLogs.length === 0) {
                logContent.innerHTML = '<div class="text-gray-500 text-center py-8">No logs found matching your criteria</div>';
            } else {
                logContent.innerHTML = filteredLogs.map(log => {
                    const level = getLogLevel(log);
                    const levelClass = level === 'ERROR' ? 'log-error' : level === 'WARNING' ? 'log-warning' : 'log-info';
                    const textColor = level === 'ERROR' ? 'text-red-400' : level === 'WARNING' ? 'text-yellow-400' : 'text-green-400';
                    
                    return `<div class="log-line ${levelClass} px-2 py-1 rounded hover:bg-gray-800 transition-colors duration-150 ${textColor}">
                        ${highlightSearchTerm(log, searchTerm)}
                    </div>`;
                }).join('');
            }
            
            document.getElementById('filteredCount').textContent = `(${filteredLogs.length} entries)`;
            
            // Show/hide scroll to bottom button
            const container = document.getElementById('logContainer');
            const scrollBtn = document.getElementById('scrollBottomBtn');
            const isAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 10;
            scrollBtn.classList.toggle('hidden', isAtBottom || filteredLogs.length === 0);
        }

        function scrollToBottom() {
            const container = document.getElementById('logContainer');
            container.scrollTop = container.scrollHeight;
        }

        async function fetchLogs() {
            try {
                const lines = document.getElementById('linesCount').value;
                const searchTerm = document.getElementById('searchInput').value;
                const level = document.getElementById('levelFilter').value;
                
                const params = new URLSearchParams({ lines });
                if (searchTerm) params.append('search', searchTerm);
                if (level) params.append('level', level);
                
                const response = await fetch(`/api/logs?${params}`);
                if (!response.ok) throw new Error('Failed to fetch logs');
                
                const data = await response.json();
                allLogs = data.logs || [];
                
                updateLogStats();
                filterLogs();
                
            } catch (error) {
                console.error('Error fetching logs:', error);
                showToast('Failed to fetch logs: ' + error.message, 'error');
                document.getElementById('logContent').innerHTML = 
                    '<div class="text-red-400 text-center py-8">Error loading logs: ' + escapeHtml(error.message) + '</div>';
            }
        }

        function refreshLogs() {
            showToast('Refreshing logs...');
            fetchLogs();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('levelFilter').value = '';
            filterLogs();
        }

        function exportLogs() {
            const dataStr = filteredLogs.join('\n');
            const dataBlob = new Blob([dataStr], {type: 'text/plain'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `ip-monitor-logs-${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            
            showToast('Logs exported successfully', 'success');
        }

        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            if (checkbox.checked && !autoRefreshInterval) {
                autoRefreshInterval = setInterval(fetchLogs, 10000); // Refresh every 10 seconds
                showToast('Auto-refresh enabled', 'success');
            } else if (!checkbox.checked && autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                showToast('Auto-refresh disabled');
            }
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', filterLogs);
        document.getElementById('levelFilter').addEventListener('change', filterLogs);
        document.getElementById('linesCount').addEventListener('change', fetchLogs);
        document.getElementById('autoRefresh').addEventListener('change', setupAutoRefresh);

        // Monitor scroll to show/hide scroll button
        document.getElementById('logContainer').addEventListener('scroll', function() {
            const container = this;
            const scrollBtn = document.getElementById('scrollBottomBtn');
            const isAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 10;
            scrollBtn.classList.toggle('hidden', isAtBottom);
        });

        // Initialize
        fetchLogs();
    </script>
</body>
</html>