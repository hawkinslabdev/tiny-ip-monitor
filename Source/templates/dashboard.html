<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ip monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .status-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .slide-up {
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .config-locked {
            background: linear-gradient(45deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-100">
    <!-- Navigation -->
    <nav class="glass sticky top-0 z-50 border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 flex items-center justify-center">
                        <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900">ip monitor</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/config" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200">
                        <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
                        Config
                    </a>
                    <button onclick="refreshData()" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200">
                        <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Status Card -->
        <div class="glass rounded-2xl p-8 mb-8 slide-up">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-4">
                    <div id="statusIndicator" class="w-4 h-4 rounded-full bg-green-500 status-pulse"></div>
                    <h2 class="text-2xl font-bold text-gray-900">
                        Status: <span id="statusText" class="text-green-600">Loading...</span>
                    </h2>
                </div>
                <div class="text-sm text-gray-500">
                    Last check: <span id="lastUpdate">--:--:--</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white/60 rounded-xl p-6 border border-white/30">
                    <div class="flex items-center space-x-3 mb-2">
                        <i data-lucide="globe" class="w-5 h-5 text-blue-600"></i>
                        <h3 class="font-medium text-gray-900">Current IP</h3>
                    </div>
                    <p id="currentIP" class="text-xl font-mono font-bold text-gray-800">Loading...</p>
                    <p class="text-sm text-gray-500 mt-1" id="ipStatus">Checking...</p>
                </div>

                <div class="bg-white/60 rounded-xl p-6 border border-white/30">
                    <div class="flex items-center space-x-3 mb-2">
                        <i data-lucide="shield-alert" class="w-5 h-5 text-red-600"></i>
                        <h3 class="font-medium text-gray-900">Protected Ranges</h3>
                    </div>
                    <p id="safeCount" class="text-xl font-bold text-gray-800">0</p>
                    <p class="text-sm text-gray-500">configured</p>
                </div>

                <div class="bg-white/60 rounded-xl p-6 border border-white/30">
                    <div class="flex items-center space-x-3 mb-2">
                        <i data-lucide="activity" class="w-5 h-5 text-purple-600"></i>
                        <h3 class="font-medium text-gray-900">Statistics</h3>
                    </div>
                    <p id="totalChecks" class="text-xl font-bold text-gray-800">0</p>
                    <p class="text-sm text-gray-500">total checks</p>
                </div>
            </div>

            <div class="flex flex-wrap gap-3 mt-6">
                <button onclick="runManualCheck()" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200 disabled:opacity-50" id="checkBtn">
                    <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                    Run Check Now
                </button>
                <button onclick="testWebhook()" class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors duration-200 disabled:opacity-50" id="webhookBtn">
                    <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                    Test Webhook
                </button>
            </div>
        </div>

        <!-- Configuration Overview -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- IP Configuration -->
            <div class="glass rounded-2xl p-6 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="settings" class="w-5 h-5 text-orange-600"></i>
                        <h3 class="text-lg font-semibold text-gray-900">IP Configuration</h3>
                    </div>
                    <div id="configSourceBadge" class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                        Loading...
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-white/50 rounded-lg p-4">
                        <label class="text-sm font-medium text-gray-600 block mb-2">Protected IP Ranges (VPN Off Alert)</label>
                        <div id="safeRanges" class="space-y-2">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div id="configLockWarning" class="config-locked rounded-lg p-4 hidden">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="lock" class="w-4 h-4 text-amber-600"></i>
                            <span class="text-sm font-medium text-amber-800">Configuration locked by environment variables</span>
                        </div>
                        <button onclick="migrateConfig()" class="mt-2 text-sm text-amber-700 hover:text-amber-900 underline">
                            Migrate to file-based configuration â†’
                        </button>
                    </div>
                </div>
            </div>

            <!-- Webhook Configuration -->
            <div class="glass rounded-2xl p-6 fade-in">
                <div class="flex items-center space-x-3 mb-6">
                    <i data-lucide="webhook" class="w-5 h-5 text-green-600"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Webhook Settings</h3>
                </div>

                <div class="space-y-4">
                    <div class="bg-white/50 rounded-lg p-4">
                        <label class="text-sm font-medium text-gray-600 block mb-1">Endpoint URL</label>
                        <code id="webhookUrl" class="text-sm bg-gray-100 px-2 py-1 rounded block break-all">loading...</code>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/50 rounded-lg p-4">
                            <label class="text-sm font-medium text-gray-600 block mb-1">Method</label>
                            <span id="webhookMethod" class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-medium">POST</span>
                        </div>
                        <div class="bg-white/50 rounded-lg p-4">
                            <label class="text-sm font-medium text-gray-600 block mb-1">Auth</label>
                            <span id="webhookAuth" class="inline-block px-2 py-1 bg-gray-100 text-gray-800 rounded text-sm font-medium">Disabled</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="glass rounded-2xl p-6 mt-8 fade-in">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <i data-lucide="clock" class="w-5 h-5 text-gray-600"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Recent Activity</h3>
                </div>
                <button onclick="downloadLogs()" class="inline-flex items-center px-2 py-1 text-sm text-gray-600 hover:text-gray-900 hover:bg-white/50 rounded-lg transition-all duration-200" title="Download full logs">
                    <i data-lucide="download" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="bg-gray-900 rounded-lg p-4 max-h-48 overflow-y-auto">
                <div id="recentLogs" class="font-mono text-sm text-green-400 space-y-1">
                    <div class="text-gray-500">Loading logs...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span class="text-gray-900 font-medium">Processing...</span>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        let currentData = {
            status: null,
            config: null,
            logs: []
        };

        function showLoading(show = true) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function updateUI() {
            if (!currentData.status || !currentData.config) return;
            
            const status = currentData.status;
            const config = currentData.config;
            
            // Update status
            const isSafe = status.is_safe;
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (!isSafe) {
                statusIndicator.className = 'w-4 h-4 rounded-full bg-red-500 status-pulse';
                statusText.textContent = 'Alert';
                statusText.className = 'text-red-600';
                document.getElementById('ipStatus').textContent = `VPN disabled - IP in protected range: ${status.protected_range}`;
            } else {
                statusIndicator.className = 'w-4 h-4 rounded-full bg-green-500 status-pulse';
                statusText.textContent = 'Protected';
                statusText.className = 'text-green-600';
                document.getElementById('ipStatus').textContent = 'VPN active - IP outside protected ranges';
            }
            
            // Update IP info
            document.getElementById('currentIP').textContent = status.current_ip || 'Unknown';
            document.getElementById('safeCount').textContent = status.protected_ranges?.length || 0;
            document.getElementById('totalChecks').textContent = status.monitor_stats?.total_checks || 0;
            
            // Update timestamp
            if (status.timestamp) {
                const timestamp = new Date(status.timestamp);
                document.getElementById('lastUpdate').textContent = timestamp.toLocaleTimeString();
            }
            
            // Update protected ranges
            const rangesContainer = document.getElementById('safeRanges');
            if (status.protected_ranges && status.protected_ranges.length > 0) {
                rangesContainer.innerHTML = status.protected_ranges.map(range => 
                    `<code class="text-sm bg-red-50 text-red-800 px-2 py-1 rounded block">${range}</code>`
                ).join('');
            } else {
                rangesContainer.innerHTML = '<div class="text-sm text-gray-500">No protected ranges configured</div>';
            }
            
            // Update config source
            const sourceBadge = document.getElementById('configSourceBadge');
            sourceBadge.textContent = config.config_source || 'unknown';
            sourceBadge.className = config.config_source === 'file' ? 
                'px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800' : 
                'px-2 py-1 rounded text-xs font-medium bg-amber-100 text-amber-800';
            
            // Show/hide config lock warning
            const lockWarning = document.getElementById('configLockWarning');
            if (!config.is_editable) {
                lockWarning.classList.remove('hidden');
            } else {
                lockWarning.classList.add('hidden');
            }
            
            // Update webhook config
            document.getElementById('webhookUrl').textContent = config.webhook_url || 'Not configured';
            document.getElementById('webhookMethod').textContent = config.webhook_method || 'POST';
            
            const authSpan = document.getElementById('webhookAuth');
            authSpan.textContent = config.webhook_user ? 'Enabled' : 'Disabled';
            authSpan.className = config.webhook_user ? 
                'inline-block px-2 py-1 bg-green-100 text-green-800 rounded text-sm font-medium' : 
                'inline-block px-2 py-1 bg-gray-100 text-gray-800 rounded text-sm font-medium';
            
            // Update recent logs
            const logsContainer = document.getElementById('recentLogs');
            if (currentData.logs && currentData.logs.length > 0) {
                logsContainer.innerHTML = currentData.logs.slice(0, 5).map(log => 
                    `<div class="hover:bg-gray-800 px-2 py-1 rounded transition-colors duration-150">${escapeHtml(log)}</div>`
                ).join('');
            } else {
                logsContainer.innerHTML = '<div class="text-gray-500">No recent logs</div>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `bg-white border-l-4 ${type === 'error' ? 'border-red-500' : type === 'success' ? 'border-green-500' : 'border-blue-500'} rounded-lg shadow-lg p-4 min-w-72 transform translate-x-full transition-transform duration-300`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <i data-lucide="${type === 'error' ? 'alert-circle' : type === 'success' ? 'check-circle' : 'info'}" class="w-5 h-5 ${type === 'error' ? 'text-red-500' : type === 'success' ? 'text-green-500' : 'text-blue-500'} mr-3"></i>
                    <span class="text-gray-900">${message}</span>
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        async function fetchData() {
            try {
                // Fetch status
                const statusResponse = await fetch('/api/status');
                if (!statusResponse.ok) throw new Error('Failed to fetch status');
                currentData.status = await statusResponse.json();
                
                // Fetch config
                const configResponse = await fetch('/api/config');
                if (!configResponse.ok) throw new Error('Failed to fetch config');
                currentData.config = await configResponse.json();
                
                // Fetch recent logs
                const logsResponse = await fetch('/api/logs?lines=5');
                if (!logsResponse.ok) throw new Error('Failed to fetch logs');
                const logsData = await logsResponse.json();
                currentData.logs = logsData.logs || [];
                
                updateUI();
                
            } catch (error) {
                console.error('Error fetching data:', error);
                showToast('Failed to fetch data: ' + error.message, 'error');
            }
        }

        function refreshData() {
            showToast('Refreshing data...');
            fetchData();
        }

        async function runManualCheck() {
            const btn = document.getElementById('checkBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>Running...';
            
            try {
                const response = await fetch('/api/test');
                const result = await response.json();
                
                if (result.success) {
                    showToast('Manual check completed successfully', 'success');
                    setTimeout(fetchData, 1000); // Refresh data after check
                } else {
                    showToast('Manual check failed: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error running check: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="play" class="w-4 h-4 mr-2"></i>Run Check Now';
                lucide.createIcons();
            }
        }

        async function testWebhook() {
            const btn = document.getElementById('webhookBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>Testing...';
            
            try {
                const response = await fetch('/api/webhook-test');
                const result = await response.json();
                
                if (result.success) {
                    showToast('Webhook test completed successfully', 'success');
                } else {
                    showToast('Webhook test failed: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error testing webhook: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="send" class="w-4 h-4 mr-2"></i>Test Webhook';
                lucide.createIcons();
            }
        }

        async function migrateConfig() {
            showLoading(true);
            
            try {
                const response = await fetch('/api/config/migrate', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showToast(result.message, 'success');
                    setTimeout(() => {
                        fetchData();
                        showLoading(false);
                    }, 1000);
                } else {
                    showToast(result.message || 'Migration failed', 'error');
                    showLoading(false);
                }
            } catch (error) {
                showToast('Error migrating config: ' + error.message, 'error');
                showLoading(false);
            }
        }

        async function downloadLogs() {
            try {
                const response = await fetch('/api/logs?lines=1000');
                const data = await response.json();
                
                if (data.error) {
                    showToast('Error fetching logs: ' + data.error, 'error');
                    return;
                }
                
                // Create downloadable JSON content
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const logData = {
                    timestamp: new Date().toISOString(),
                    total_logs: data.total,
                    filters: data.filters,
                    logs: data.logs
                };
                
                const jsonContent = JSON.stringify(logData, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                
                // Create download link
                const a = document.createElement('a');
                a.href = url;
                a.download = `logs_${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showToast('Logs downloaded successfully', 'success');
            } catch (error) {
                showToast('Error downloading logs: ' + error.message, 'error');
            }
        }

        // Initialize the page
        fetchData();
        
        // Auto-refresh every 30 seconds
        setInterval(fetchData, 30000);
    </script>
</body>
</html>